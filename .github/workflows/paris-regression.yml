name: üß™ Paris Generation Regression

on:
  push:
    branches: [ main, dev ]
    paths:
      - 'crates/**/*.rs'
      - 'examples/paris/**'
      - '.github/workflows/paris-regression.yml'
  pull_request:
    branches: [ main, dev ]
    paths:
      - 'crates/**/*.rs'
      - 'examples/paris/**'
      - '.github/workflows/paris-regression.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  MODEL_NAME: tinyllama-1.1b-chat-v1.0.Q4_K_M.gguf
  MODEL_URL: https://huggingface.co/TheBloke/TinyLlama-1.1B-Chat-v1.0-GGUF/resolve/main/tinyllama-1.1b-chat-v1.0.Q4_K_M.gguf
  MODEL_SHA256: 6c4c8b6b8c4f4e8b6c4c8b6b8c4f4e8b6c4c8b6b8c4f4e8b6c4c8b6b8c4f4e8b6  # Placeholder - update with actual hash

jobs:
  paris-regression:
    name: üéØ Paris Generation Regression
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-paris-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache model file
        id: model-cache
        uses: actions/cache@v4
        with:
          path: ~/.realm/models
          key: ${{ runner.os }}-tinyllama-model-${{ env.MODEL_NAME }}
          restore-keys: |
            ${{ runner.os }}-tinyllama-model-

      - name: Download model if not cached
        if: steps.model-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.realm/models
          echo "üì• Downloading model from HuggingFace..."
          wget -q --show-progress --progress=bar:force:noscroll \
            -O ~/.realm/models/${{ env.MODEL_NAME }} \
            ${{ env.MODEL_URL }} || \
          curl -L --progress-bar \
            -o ~/.realm/models/${{ env.MODEL_NAME }} \
            ${{ env.MODEL_URL }}
          
          echo "‚úÖ Model downloaded"
          ls -lh ~/.realm/models/${{ env.MODEL_NAME }}
          
          # Verify file size (should be ~640MB)
          FILE_SIZE=$(stat -c%s ~/.realm/models/${{ env.MODEL_NAME }} 2>/dev/null || stat -f%z ~/.realm/models/${{ env.MODEL_NAME }})
          if [ $FILE_SIZE -lt 500000000 ]; then
            echo "‚ùå Model file seems too small: $FILE_SIZE bytes"
            exit 1
          fi

      - name: Verify model exists
        run: |
          if [ ! -f ~/.realm/models/${{ env.MODEL_NAME }} ]; then
            echo "‚ùå Model file not found!"
            exit 1
          fi
          echo "‚úÖ Model file verified: ~/.realm/models/${{ env.MODEL_NAME }}"
          ls -lh ~/.realm/models/${{ env.MODEL_NAME }}

      - name: Build workspace
        run: |
          echo "üî® Building workspace..."
          cargo build --release --workspace
          echo "‚úÖ Build complete"

      - name: Build WASM
        run: |
          echo "üåê Building WASM..."
          cargo build --release --target wasm32-unknown-unknown -p realm-wasm
          echo "‚úÖ WASM build complete"

      - name: Build server
        run: |
          echo "üèóÔ∏è Building server..."
          cargo build --release --bin realm
          echo "‚úÖ Server build complete"

      - name: Test Native Rust Stack
        id: test-native
        run: |
          echo "=========================================="
          echo "1Ô∏è‚É£ Testing Native Rust Stack"
          echo "=========================================="
          
          cd examples/paris/native
          MODEL_PATH=~/.realm/models/${{ env.MODEL_NAME }}
          
          timeout 120 cargo run --release -- "${MODEL_PATH}" "What is the capital of France?" 2>&1 | tee /tmp/native.log
          
          if grep -qi "paris" /tmp/native.log && grep -qi "SUCCESS" /tmp/native.log; then
            echo "‚úÖ Native Rust: PASSED - Produces 'Paris'"
            echo "native=passed" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Native Rust: FAILED"
            echo "Last 20 lines:"
            tail -20 /tmp/native.log
            echo "native=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Test Node.js SDK Stack
        id: test-nodejs
        run: |
          echo "=========================================="
          echo "2Ô∏è‚É£ Testing Node.js SDK Stack"
          echo "=========================================="
          
          # Install Node.js SDK dependencies
          cd examples/paris/nodejs-sdk
          npm ci || npm install
          
          # Start server in background
          cd ../..
          timeout 180 target/release/realm serve \
            --host 127.0.0.1 \
            --port 8080 \
            --wasm target/wasm32-unknown-unknown/release/realm_wasm.wasm \
            --model ~/.realm/models/${{ env.MODEL_NAME }} \
            > /tmp/server_node.log 2>&1 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # Wait for server to be ready
          echo "‚è≥ Waiting for server to be ready..."
          for i in {1..30}; do
            if curl -s http://127.0.0.1:8080/health > /dev/null 2>&1; then
              echo "‚úÖ Server is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå Server failed to start"
              cat /tmp/server_node.log
              kill $SERVER_PID 2>/dev/null || true
              exit 1
            fi
            sleep 2
          done
          
          sleep 3
          
          # Run Node.js SDK test
          cd examples/paris/nodejs-sdk
          REALM_URL=ws://localhost:8080 \
          REALM_MODEL=${{ env.MODEL_NAME }} \
          timeout 60 node index.js 2>&1 | tee /tmp/nodejs.log
          
          # Stop server
          kill $SERVER_PID 2>/dev/null || true
          wait $SERVER_PID 2>/dev/null || true
          
          if grep -qi "paris" /tmp/nodejs.log && grep -qi "SUCCESS" /tmp/nodejs.log; then
            echo "‚úÖ Node.js SDK: PASSED - Produces 'Paris'"
            echo "nodejs=passed" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Node.js SDK: FAILED"
            echo "Last 20 lines:"
            tail -20 /tmp/nodejs.log
            echo "nodejs=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Test Python SDK Stack
        id: test-python
        run: |
          echo "=========================================="
          echo "3Ô∏è‚É£ Testing Python SDK Stack"
          echo "=========================================="
          
          # Install Python SDK
          cd sdks/python-ws
          pip install -e .
          cd ../..
          
          # Install Python dependencies
          cd examples/paris/python-sdk
          pip install -r requirements.txt
          
          # Start server in background
          cd ../..
          timeout 180 target/release/realm serve \
            --host 127.0.0.1 \
            --port 8081 \
            --wasm target/wasm32-unknown-unknown/release/realm_wasm.wasm \
            --model ~/.realm/models/${{ env.MODEL_NAME }} \
            > /tmp/server_python.log 2>&1 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # Wait for server to be ready
          echo "‚è≥ Waiting for server to be ready..."
          for i in {1..30}; do
            if curl -s http://127.0.0.1:8081/health > /dev/null 2>&1; then
              echo "‚úÖ Server is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå Server failed to start"
              cat /tmp/server_python.log
              kill $SERVER_PID 2>/dev/null || true
              exit 1
            fi
            sleep 2
          done
          
          sleep 3
          
          # Run Python SDK test
          cd examples/paris/python-sdk
          REALM_URL=ws://localhost:8081 \
          REALM_MODEL=${{ env.MODEL_NAME }} \
          timeout 60 python3 main.py 2>&1 | tee /tmp/python.log
          
          # Stop server
          kill $SERVER_PID 2>/dev/null || true
          wait $SERVER_PID 2>/dev/null || true
          
          if grep -qi "paris" /tmp/python.log && grep -qi "SUCCESS" /tmp/python.log; then
            echo "‚úÖ Python SDK: PASSED - Produces 'Paris'"
            echo "python=passed" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Python SDK: FAILED"
            echo "Last 20 lines:"
            tail -20 /tmp/python.log
            echo "python=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "üìä Paris Generation Regression Summary"
          echo "=========================================="
          echo ""
          echo "Native Rust: ${{ steps.test-native.outputs.native }}"
          echo "Node.js SDK: ${{ steps.test-nodejs.outputs.nodejs }}"
          echo "Python SDK:  ${{ steps.test-python.outputs.python }}"
          echo ""
          
          if [ "${{ steps.test-native.outputs.native }}" = "passed" ] && \
             [ "${{ steps.test-nodejs.outputs.nodejs }}" = "passed" ] && \
             [ "${{ steps.test-python.outputs.python }}" = "passed" ]; then
            echo "‚úÖ ALL STACKS PASSED - Paris generation working!"
            exit 0
          else
            echo "‚ùå SOME STACKS FAILED - Review logs above"
            exit 1
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: paris-regression-logs
          path: |
            /tmp/native.log
            /tmp/nodejs.log
            /tmp/python.log
            /tmp/server_node.log
            /tmp/server_python.log
          retention-days: 7

