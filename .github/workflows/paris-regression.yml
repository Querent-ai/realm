name: üß™ Paris Generation Regression

on:
  push:
    branches: [main, dev]
    paths:
      - "crates/**/*.rs"
      - "examples/paris/**"
      - ".github/workflows/paris-regression.yml"
  pull_request:
    branches: [main, dev]
    paths:
      - "crates/**/*.rs"
      - "examples/paris/**"
      - ".github/workflows/paris-regression.yml"
  workflow_dispatch: # Allow manual trigger

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  MODEL_NAME: tinyllama-1.1b-chat-v1.0.Q4_K_M.gguf
  MODEL_URL: https://huggingface.co/TheBloke/TinyLlama-1.1B-Chat-v1.0-GGUF/resolve/main/tinyllama-1.1b-chat-v1.0.Q4_K_M.gguf
  MODEL_SHA256: 6c4c8b6b8c4f4e8b6c4c8b6b8c4f4e8b6c4c8b6b8c4f4e8b6c4c8b6b8c4f4e8b6 # Placeholder - update with actual hash

jobs:
  paris-regression:
    name: üéØ Paris Generation Regression
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set workspace root
        run: |
          echo "REPO_ROOT=$(pwd)" >> $GITHUB_ENV
          echo "Workspace root: $REPO_ROOT"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-paris-${{ hashFiles('Cargo.lock') }}

      - name: Cache model file
        id: model-cache
        uses: actions/cache@v4
        with:
          path: ~/.realm/models
          key: ${{ runner.os }}-tinyllama-model-${{ env.MODEL_NAME }}
          restore-keys: |
            ${{ runner.os }}-tinyllama-model-

      - name: Download model if not cached
        if: steps.model-cache.outputs.cache-hit != 'true'
        timeout-minutes: 10
        run: |
          MODEL_DIR="$HOME/.realm/models"
          MODEL_PATH="$MODEL_DIR/${{ env.MODEL_NAME }}"
          mkdir -p "$MODEL_DIR"
          echo "üì• Downloading model from HuggingFace..."
          echo "   URL: ${{ env.MODEL_URL }}"
          echo "   Destination: $MODEL_PATH"
          echo "   Directory: $MODEL_DIR"

          # Try wget first, fallback to curl
          if command -v wget &> /dev/null; then
            echo "   Using wget..."
            wget --no-verbose --show-progress \
              -O "$MODEL_PATH" \
              "${{ env.MODEL_URL }}" || {
              echo "‚ö†Ô∏è  wget failed, trying curl..."
              curl -L --progress-bar \
                -o "$MODEL_PATH" \
                "${{ env.MODEL_URL }}"
            }
          else
            echo "   Using curl..."
            curl -L --progress-bar \
              -o "$MODEL_PATH" \
              "${{ env.MODEL_URL }}"
          fi

          # Check if download succeeded
          if [ ! -f "$MODEL_PATH" ]; then
            echo "‚ùå Model file not created after download!"
            exit 1
          fi

          echo "‚úÖ Model downloaded"
          ls -lh "$MODEL_PATH"

          # Verify file size (should be ~640MB)
          FILE_SIZE=$(stat -c%s "$MODEL_PATH" 2>/dev/null || stat -f%z "$MODEL_PATH")
          FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
          echo "   File size: $FILE_SIZE bytes (${FILE_SIZE_MB}MB)"
          if [ $FILE_SIZE -lt 500000000 ]; then
            echo "‚ùå Model file seems too small: $FILE_SIZE bytes (expected > 500MB)"
            echo "   This might indicate a failed or partial download"
            exit 1
          fi

          echo "‚úÖ Model download verified"

      - name: Verify model exists
        run: |
          MODEL_PATH="$HOME/.realm/models/${{ env.MODEL_NAME }}"
          if [ ! -f "$MODEL_PATH" ]; then
            echo "‚ùå Model file not found: $MODEL_PATH"
            echo "   Listing $HOME/.realm/models:"
            ls -la "$HOME/.realm/models" || echo "   Directory does not exist"
            exit 1
          fi
          echo "‚úÖ Model file verified: $MODEL_PATH"
          ls -lh "$MODEL_PATH"

      - name: Build workspace
        run: |
          echo "üî® Building workspace..."
          cargo build --release --workspace
          echo "‚úÖ Build complete"

      - name: Build WASM
        run: |
          echo "üåê Building WASM..."
          cargo build --release --target wasm32-unknown-unknown -p realm-wasm
          echo "‚úÖ WASM build complete"

      - name: Build server
        run: |
          echo "üèóÔ∏è Building server..."
          cargo build --release --bin realm
          echo "‚úÖ Server build complete"

      - name: Build Native Rust Example
        run: |
          echo "üî® Building Native Rust example..."
          cargo build --release --bin paris-native || {
            echo "‚ùå Build failed"
            exit 1
          }
          echo "‚úÖ Build complete"
          ls -lh target/release/paris-native || echo "‚ö†Ô∏è  Binary not found"

      - name: Test Native Rust Stack
        id: test-native
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "1Ô∏è‚É£ Testing Native Rust Stack"
          echo "=========================================="

          # Initialize output to failed (will be overwritten on success)
          echo "native=failed" >> $GITHUB_OUTPUT

          MODEL_PATH="$HOME/.realm/models/${{ env.MODEL_NAME }}"
          echo "Model path: $MODEL_PATH"
          echo "Current directory: $(pwd)"
          echo "Model file exists: $([ -f "$MODEL_PATH" ] && echo 'yes' || echo 'no')"

          if [ ! -f "$MODEL_PATH" ]; then
            echo "‚ùå Model file not found: $MODEL_PATH"
            echo "Listing $HOME/.realm/models:"
            ls -la "$HOME/.realm/models" 2>&1 || echo "Directory doesn't exist"
            exit 1
          fi

          echo "‚úÖ Model file found, running test..."

          # Run test using pre-built binary (faster, no compilation)
          set +e
          timeout 180 ./target/release/paris-native "$MODEL_PATH" "What is the capital of France?" 2>&1 | tee /tmp/native.log
          EXIT_CODE=${PIPESTATUS[0]}
          set -e

          echo ""
          echo "Test completed with exit code: $EXIT_CODE"
          echo "Log file size: $(wc -l < /tmp/native.log) lines"

          # Show what we're searching for
          echo ""
          echo "Checking for 'Paris' (case-insensitive):"
          grep -i "paris" /tmp/native.log | head -5 || echo "  No 'paris' found"

          echo "Checking for 'SUCCESS' (case-insensitive):"
          grep -i "success" /tmp/native.log | head -5 || echo "  No 'success' found"

          # Check for Paris in output
          if grep -qi "paris" /tmp/native.log && grep -qi "SUCCESS" /tmp/native.log; then
            echo ""
            echo "‚úÖ Native Rust: PASSED - Produces 'Paris'"
            echo "native=passed" >> $GITHUB_OUTPUT
            exit 0
          else
            echo ""
            echo "‚ùå Native Rust: FAILED"
            echo "Exit code: $EXIT_CODE"
            echo "Full log file (last 50 lines):"
            tail -50 /tmp/native.log
            exit 1
          fi

      - name: Build Node.js SDK
        run: |
          echo "üî® Building Node.js SDK..."
          cd "$REPO_ROOT/sdks/nodejs-ws" || {
            echo "‚ùå Failed to cd to sdks/nodejs-ws"
            exit 1
          }
          npm install || {
            echo "‚ùå Failed to install SDK dependencies"
            exit 1
          }
          # Build TypeScript (examples may have errors, but main code should build)
          # TypeScript will emit files even if examples have errors
          set +e
          npx tsc --project tsconfig.json --skipLibCheck 2>&1 | grep -v "error TS" || true
          set -e

          # Check if dist/index.js exists (main requirement)
          if [ ! -f "dist/index.js" ]; then
            echo "‚ùå SDK build failed - dist/index.js not found"
            echo "Checking dist directory:"
            ls -la dist/ 2>/dev/null || echo "dist/ does not exist"
            exit 1
          fi
          echo "‚úÖ SDK build complete - dist/index.js exists"

      - name: Test Node.js SDK Stack
        id: test-nodejs
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "2Ô∏è‚É£ Testing Node.js SDK Stack"
          echo "=========================================="

          # Initialize output to failed
          echo "nodejs=failed" >> $GITHUB_OUTPUT

          # Install Node.js SDK dependencies
          cd "$REPO_ROOT/examples/paris/nodejs-sdk" || {
            echo "‚ùå Failed to cd to examples/paris/nodejs-sdk"
            exit 1
          }

          echo "Installing Node.js dependencies..."
          # Use npm install (npm ci requires package-lock.json which may not exist in CI)
          npm install || {
            echo "‚ùå Failed to install Node.js dependencies"
            exit 1
          }

          # Start server in background (from workspace root)
          # Use absolute paths from workspace root
          if [ -z "$REPO_ROOT" ]; then
            REPO_ROOT="$GITHUB_WORKSPACE"
          fi

          MODEL_PATH="$HOME/.realm/models/${{ env.MODEL_NAME }}"
          SERVER_BIN="$REPO_ROOT/target/release/realm"
          WASM_FILE="$REPO_ROOT/target/wasm32-unknown-unknown/release/realm_wasm.wasm"

          echo "Starting server with model: $MODEL_PATH"
          echo "Workspace root: $REPO_ROOT"
          echo "Current directory: $(pwd)"
          echo "Model exists: $([ -f "$MODEL_PATH" ] && echo 'yes' || echo 'no')"
          echo "Server binary: $SERVER_BIN"
          echo "Server binary exists: $([ -f "$SERVER_BIN" ] && echo 'yes' || echo 'no')"

          if [ ! -f "$MODEL_PATH" ]; then
            echo "‚ùå Model file not found: $MODEL_PATH"
            exit 1
          fi

          if [ ! -f "$SERVER_BIN" ]; then
            echo "‚ùå Server binary not found at $SERVER_BIN"
            echo "Looking for binary in $REPO_ROOT/target/release/:"
            ls -la "$REPO_ROOT/target/release/" 2>/dev/null | head -5 || echo "Directory does not exist"
            exit 1
          fi

          echo "‚úÖ Starting server..."
          timeout 180 "$SERVER_BIN" serve \
            --host 127.0.0.1 \
            --port 8080 \
            --wasm "$WASM_FILE" \
            --model "$MODEL_PATH" \
            > /tmp/server_node.log 2>&1 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"

          # Wait for server to be ready
          echo "‚è≥ Waiting for server to be ready..."
          SERVER_READY=false
          for i in {1..30}; do
            # Check if server process is still running
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "‚ùå Server process died!"
              cat /tmp/server_node.log
              SERVER_READY=false
              break
            fi
            # Check server log for "Server ready" message
            if grep -q "Server ready\|server listening" /tmp/server_node.log 2>/dev/null; then
              echo "‚úÖ Server is ready (attempt $i)"
              SERVER_READY=true
              break
            fi
            echo "  Attempt $i/30: Server not ready yet..."
            sleep 2
          done

          if [ "$SERVER_READY" != "true" ]; then
            echo "‚ùå Server failed to start after 60 seconds"
            echo "Server log:"
            cat /tmp/server_node.log
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi

          sleep 3

          # Run Node.js SDK test (from correct directory)
          set +e
          cd "$REPO_ROOT/examples/paris/nodejs-sdk" || {
            echo "‚ùå Failed to cd to examples/paris/nodejs-sdk"
            exit 1
          }
          REALM_URL=ws://localhost:8080 \
          REALM_MODEL=${{ env.MODEL_NAME }} \
          timeout 60 node index.js 2>&1 | tee /tmp/nodejs.log
          EXIT_CODE=${PIPESTATUS[0]}
          set -e

          # Stop server
          kill $SERVER_PID 2>/dev/null || true
          wait $SERVER_PID 2>/dev/null || true

          echo ""
          echo "Test completed with exit code: $EXIT_CODE"
          echo "Checking for 'Paris':"
          grep -i "paris" /tmp/nodejs.log | head -3 || echo "  No 'paris' found"
          echo "Checking for 'SUCCESS':"
          grep -i "success" /tmp/nodejs.log | head -3 || echo "  No 'success' found"

          if grep -qi "paris" /tmp/nodejs.log && grep -qi "SUCCESS" /tmp/nodejs.log; then
            echo ""
            echo "‚úÖ Node.js SDK: PASSED - Produces 'Paris'"
            echo "nodejs=passed" >> $GITHUB_OUTPUT
            exit 0
          else
            echo ""
            echo "‚ùå Node.js SDK: FAILED"
            echo "Exit code: $EXIT_CODE"
            echo "Last 50 lines:"
            tail -50 /tmp/nodejs.log
            exit 1
          fi

      - name: Test Python SDK Stack
        id: test-python
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "3Ô∏è‚É£ Testing Python SDK Stack"
          echo "=========================================="

          # Initialize output to failed
          echo "python=failed" >> $GITHUB_OUTPUT

          # Install Python SDK
          cd sdks/python-ws || {
            echo "‚ùå Failed to cd to sdks/python-ws"
            exit 1
          }

          echo "Installing Python SDK..."
          pip install -e . || {
            echo "‚ùå Failed to install Python SDK"
            exit 1
          }
          cd ../..

          # Install Python dependencies
          cd examples/paris/python-sdk || {
            echo "‚ùå Failed to cd to examples/paris/python-sdk"
            exit 1
          }

          echo "Installing Python dependencies..."
          pip install -r requirements.txt || {
            echo "‚ùå Failed to install Python dependencies"
            exit 1
          }

          # Start server in background (from workspace root)
          # Use absolute paths from workspace root
          if [ -z "$REPO_ROOT" ]; then
            REPO_ROOT="$GITHUB_WORKSPACE"
          fi

          MODEL_PATH="$HOME/.realm/models/${{ env.MODEL_NAME }}"
          SERVER_BIN="$REPO_ROOT/target/release/realm"
          WASM_FILE="$REPO_ROOT/target/wasm32-unknown-unknown/release/realm_wasm.wasm"

          echo "Starting server with model: $MODEL_PATH"
          echo "Workspace root: $REPO_ROOT"
          echo "Current directory: $(pwd)"
          echo "Model exists: $([ -f "$MODEL_PATH" ] && echo 'yes' || echo 'no')"
          echo "Server binary: $SERVER_BIN"
          echo "Server binary exists: $([ -f "$SERVER_BIN" ] && echo 'yes' || echo 'no')"

          if [ ! -f "$MODEL_PATH" ]; then
            echo "‚ùå Model file not found: $MODEL_PATH"
            exit 1
          fi

          if [ ! -f "$SERVER_BIN" ]; then
            echo "‚ùå Server binary not found at $SERVER_BIN"
            echo "Looking for binary in $REPO_ROOT/target/release/:"
            ls -la "$REPO_ROOT/target/release/" 2>/dev/null | head -5 || echo "Directory does not exist"
            exit 1
          fi

          echo "‚úÖ Starting server..."
          timeout 180 "$SERVER_BIN" serve \
            --host 127.0.0.1 \
            --port 8081 \
            --wasm "$WASM_FILE" \
            --model "$MODEL_PATH" \
            > /tmp/server_python.log 2>&1 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"

          # Wait for server to be ready
          echo "‚è≥ Waiting for server to be ready..."
          SERVER_READY=false
          for i in {1..30}; do
            # Check if server process is still running
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "‚ùå Server process died!"
              cat /tmp/server_python.log
              SERVER_READY=false
              break
            fi
            # Check server log for "Server ready" message
            if grep -q "Server ready\|server listening" /tmp/server_python.log 2>/dev/null; then
              echo "‚úÖ Server is ready (attempt $i)"
              SERVER_READY=true
              break
            fi
            echo "  Attempt $i/30: Server not ready yet..."
            sleep 2
          done

          if [ "$SERVER_READY" != "true" ]; then
            echo "‚ùå Server failed to start after 60 seconds"
            echo "Server log:"
            cat /tmp/server_python.log
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi

          sleep 3

          # Run Python SDK test
          set +e
          cd examples/paris/python-sdk
          REALM_URL=ws://localhost:8081 \
          REALM_MODEL=${{ env.MODEL_NAME }} \
          timeout 60 python3 main.py 2>&1 | tee /tmp/python.log
          EXIT_CODE=${PIPESTATUS[0]}
          set -e

          # Stop server
          kill $SERVER_PID 2>/dev/null || true
          wait $SERVER_PID 2>/dev/null || true

          echo ""
          echo "Test completed with exit code: $EXIT_CODE"
          echo "Checking for 'Paris':"
          grep -i "paris" /tmp/python.log | head -3 || echo "  No 'paris' found"
          echo "Checking for 'SUCCESS':"
          grep -i "success" /tmp/python.log | head -3 || echo "  No 'success' found"

          if grep -qi "paris" /tmp/python.log && grep -qi "SUCCESS" /tmp/python.log; then
            echo ""
            echo "‚úÖ Python SDK: PASSED - Produces 'Paris'"
            echo "python=passed" >> $GITHUB_OUTPUT
            exit 0
          else
            echo ""
            echo "‚ùå Python SDK: FAILED"
            echo "Exit code: $EXIT_CODE"
            echo "Last 50 lines:"
            tail -50 /tmp/python.log
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "üìä Paris Generation Regression Summary"
          echo "=========================================="
          echo ""

          NATIVE_STATUS="${{ steps.test-native.outputs.native }}"
          NODEJS_STATUS="${{ steps.test-nodejs.outputs.nodejs }}"
          PYTHON_STATUS="${{ steps.test-python.outputs.python }}"

          echo "Native Rust: ${NATIVE_STATUS:-unknown}"
          echo "Node.js SDK: ${NODEJS_STATUS:-unknown}"
          echo "Python SDK:  ${PYTHON_STATUS:-unknown}"
          echo ""

          # Check if all passed
          if [ "${NATIVE_STATUS}" = "passed" ] && \
             [ "${NODEJS_STATUS}" = "passed" ] && \
             [ "${PYTHON_STATUS}" = "passed" ]; then
            echo "‚úÖ ALL STACKS PASSED - Paris generation working!"
            exit 0
          else
            echo "‚ùå SOME STACKS FAILED - Review logs above"
            echo ""
            echo "Failed stacks:"
            [ "${NATIVE_STATUS}" != "passed" ] && echo "  - Native Rust"
            [ "${NODEJS_STATUS}" != "passed" ] && echo "  - Node.js SDK"
            [ "${PYTHON_STATUS}" != "passed" ] && echo "  - Python SDK"
            exit 1
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: paris-regression-logs
          path: |
            /tmp/native.log
            /tmp/nodejs.log
            /tmp/python.log
            /tmp/server_node.log
            /tmp/server_python.log
          retention-days: 7
